# PDF智能重排工具 - 工作日志

**日期**: 2026-02-08
**项目**: `/home/wu/桌面/pdf_zhongjiban`
**版本**: v2.0

---

## 项目概述

整合横版和竖版PDF重排功能，实现自动方向检测和混合PDF处理。

**源项目**:
- 横版: `/home/wu/桌面/pdf横版`
- 竖版: `/home/wu/桌面/pdf2竖版`

---

## 主要问题与修复历史

### 1. 竖版处理位置混乱 ✅ 已修复

**问题**: 整合后竖版PDF字符位置混乱

**原因**:
- 使用了错误的聚类方法 `_cluster_by_x_vertical`（复杂版本）
- 应该使用原始竖版项目的 `_cluster_by_x_simple`（简单版本）

**修复** (commit: a04d769):
```python
# src/segmenter.py
def segment_vertical():
    blocks = self._extract_blocks_for_vertical(processed, gray_image)  # 不去重
    columns = self._cluster_by_x_simple(blocks)  # 使用简单聚类
```

**关键参数**:
- `_extract_blocks_for_vertical`: area<50, w<5 and h<5, 不去重
- `_cluster_by_x_simple`: tolerance = median_w * 0.8

**测试结果**: 龍樹_page5.pdf 生成210个字符，与原始竖版项目一致 ✅

---

### 2. 方向检测误判 ✅ 已修复

**问题**: 横版PDF被误判为竖版

**原因**:
- 检测时使用了 `_extract_blocks_for_vertical`（area<50），过滤太严格
- 横版PDF字块太少（43个），聚类结果不准确
- 列数限制太严（<=10），龍樹_page5有16列被误判

**修复** (commit: b1c14cb):
```python
# src/segmenter.py
def detect_orientation():
    blocks = self._extract_blocks(processed, gray_image)  # 使用横版参数area<30
    columns = self._cluster_by_x_simple(blocks)

    # 提高阈值，放宽列数限制
    if avg_per_col > avg_per_row * 2.0 and len(columns) <= 20:
        return "vertical"
```

**测试结果**:
- 龍樹_page5.pdf 正确检测为竖版 ✅
- 唐诗选注评鉴 第2、6、11页正确检测为横版 ✅

---

### 3. 横版放大倍数不起作用 ⚠️ 部分修复

**问题**: GUI中设置放大3倍、5倍，字体没有变大

**根本原因**:
1. **全局缩放限制**: 最宽的条（1654像素）限制了所有条的缩放比例
   - 第5页有25个超宽条（占71%），导致全局缩放只有1.21倍
   - 大部分条很小（平均40像素），但被全局缩放限制

2. **所有页混在一起处理**: pipeline中 `all_chars.extend(chars)` 导致横版竖版字符混合

**修复历程**:

#### 尝试1: 全局缩放 ❌ 失败
```python
# 找到最宽的条，计算全局缩放
max_width = max(c.image.shape[1] for c in characters)
global_scale = min(user_scale, available_width / max_width)
```
**问题**: 一个超宽条限制了所有条

#### 尝试2: 独立缩放超宽条 ❌ 失败
```python
# 每个条独立缩放，超宽的单独缩小
new_w = int(w * user_scale)
if new_w > available_width:
    scale_down = available_width / new_w
    new_w = available_width
```
**问题**: 大部分条还是很小

#### 尝试3: 横版竖版分别缩放 ❌ 失败
```python
# 根据平均宽度判断
avg_width = sum(c.image.shape[1] for c in characters) / len(characters)
user_scale = config.scale_factor if avg_width > 100 else 1.5
```
**问题**: 所有页混在一起，判断不准

#### 尝试4: 按页独立处理 ✅ 当前方案
```python
# src/pipeline.py
for i, img_pil in enumerate(images):
    chars = self.segmenter.segment(binary, gray)
    if chars:
        page_output = self.layouter.layout(chars)  # 每页独立排版
        output_pages.extend(page_output)
```

#### 尝试5: 降低gap_threshold ✅ 当前方案
```python
# src/segmenter.py
gap_threshold = avg_width * 0.3  # 从0.5降到0.3
```
**目的**: 让条更短，放大后不会超宽

**当前状态**:
- 竖版: 应该正常（使用scale_factor=1.5）
- 横版: 部分字变大，大部分还是很小 ⚠️

---

## 当前代码状态

### 核心参数

#### 横版处理 (segment_horizontal)
```python
# 字块提取
area < 30
w < 3 and h < 3
w > binary.shape[1] * 0.5  # 过滤太宽
h > binary.shape[0] * 0.3  # 过滤太高

# 条状分割
gap_threshold = avg_width * 0.3  # 当前值

# 去重
_remove_overlapping_blocks()  # 有去重逻辑
```

#### 竖版处理 (segment_vertical)
```python
# 字块提取
area < 50
w < 5 and h < 5
w > binary.shape[1] * 0.8
h > binary.shape[0] * 0.8

# 不去重
_extract_blocks_for_vertical()  # 无去重

# 聚类
tolerance = median_w * 0.8
```

#### 方向检测 (detect_orientation)
```python
# 使用横版参数提取
blocks = self._extract_blocks(processed, gray_image)

# 判断条件
if avg_per_col > avg_per_row * 2.0 and len(columns) <= 20:
    return "vertical"
```

#### 布局 (layouter)
```python
# 简单缩放
scale = self.config.output.scale_factor
new_h, new_w = int(h * scale), int(w * scale)

# 无特殊处理
```

---

## 待解决问题

### 1. 横版放大倍数仍不起作用 ⚠️ 高优先级

**现象**:
- 设置放大3倍、5倍
- 只有小部分字条变大
- 大部分字条还是很小

**可能原因**:
1. gap_threshold=0.3 还是太大，条还是太长
2. 某些页有特别宽的条，影响整体效果
3. 需要进一步分析字条宽度分布

**建议方案**:
- 继续降低gap_threshold到0.2或0.15
- 或者在layouter中添加超宽条的特殊处理
- 或者分析具体哪些页有问题，针对性处理

### 2. 竖版位置可能还有问题 ⚠️

**用户反馈**: "竖版不对"

**需要确认**:
- 是否和原始竖版项目输出一致
- 具体是什么问题（顺序、位置、大小）

---

## 测试文件

### 竖版测试
- **文件**: `龍樹_page5.pdf`
- **预期**: 210个字符，从右到左，从上到下
- **最新测试**: `/tmp/test_vertical_isolated.pdf`

### 横版测试
- **文件**: `/home/wu/桌面/pdf横版/唐诗选注评鉴_第1部分_part1.pdf`
- **页面情况**:
  - 第1页: 竖版（43个字符）
  - 第2页: 横版（64个条）
  - 第3页: 竖版（34个字符）
  - 第4页: 横版（28个条，2个超宽）
  - 第5页: 横版（35个条，25个超宽 71%）
- **最新测试**: `/tmp/test_final_fix.pdf`

---

## Git提交历史

```
8e7a670 fix: 恢复简单缩放逻辑，降低横版gap_threshold
9a7ddfd fix: 按页独立处理，横版竖版完全隔离
870d099 fix: 横版竖版分别处理缩放
d2099ae fix: 修复横版放大倍数不起作用的问题
b1c14cb fix: 修复方向检测误判问题
a04d769 fix: 修复竖版处理位置混乱问题
```

---

## 下一步工作

1. **继续调试横版放大问题**
   - 分析第5页为什么有71%的超宽条
   - 测试gap_threshold=0.2的效果
   - 考虑是否需要在layouter中特殊处理

2. **确认竖版问题**
   - 对比原始竖版项目输出
   - 确认具体问题所在

3. **完成后推送到GitHub**
   - 更新v2.0标签
   - 触发GitHub Actions构建

---

## 重要提醒

⚠️ **不要轻易改动参数！**

所有参数都是原项目反复调试的结果：
- 横版: 来自 `/home/wu/桌面/pdf横版`
- 竖版: 来自 `/home/wu/桌面/pdf2竖版`

修改参数前必须：
1. 理解参数的作用
2. 测试修改的影响
3. 确保不影响另一个版本

---

## 联系方式

如有问题，请在新窗口继续修复。

**当前上下文**: 约130K tokens，接近限制
